#!/bin/bash
# Copyright 2024-2025 Gravtice
# SPDX-License-Identifier: Apache-2.0
#
# gbox - Gravtice AgentBox main script (loads modular components and executes command routing)

set -e

# Resolve symlinks to find the real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # Handle relative symlinks
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/state.sh"
source "$SCRIPT_DIR/lib/docker.sh"
source "$SCRIPT_DIR/lib/container.sh"
source "$SCRIPT_DIR/lib/agent.sh"
source "$SCRIPT_DIR/lib/image.sh"
source "$SCRIPT_DIR/lib/oauth.sh"
source "$SCRIPT_DIR/lib/apikey.sh"
source "$SCRIPT_DIR/lib/keepalive.sh"

check_docker
check_jq
init_state

# Load .env and .env.local files
load_env_files

case "${1:-}" in
    list)
        list_containers
        ;;
    status)
        show_status
        ;;
    stop)
        stop_container "$2"
        ;;
    stop-all)
        stop_all_containers
        ;;
    clean)
        clean_containers
        ;;
    apikey)
        set +e  # Temporarily disable exit on error for apikey commands
        handle_apikey_command "${@:2}"
        exit_code=$?
        set -e  # Re-enable exit on error
        exit $exit_code
        ;;
    oauth)
        handle_oauth_command "${@:2}"
        ;;
    keepalive)
        handle_keepalive_command "${@:2}"
        ;;
    pull)
        pull_image "$2"
        ;;
    push)
        push_image "$2"
        ;;
    logs)
        show_logs "$2"
        ;;
    exec)
        exec_command "$2" "${@:3}"
        ;;
    shell)
        shell_command "$2"
        ;;
    build)
        build_image "${@:2}"
        ;;
    -h|--help|help)
        print_usage "$2"
        ;;
    -v|--version|version)
        echo "gbox version $VERSION"
        exit 0
        ;;
    *)
        # Command format:
        # gbox <agent> [-- <args>]       -> only-local mode
        # gbox happy <agent> [-- <args>] -> local-remote mode
        first_arg="$1"

        if [[ -z "$first_arg" ]]; then
            echo -e "${RED}Error: Please specify agent or command${NC}"
            echo ""
            print_usage
            exit 1
        fi

        run_mode=""
        agent=""
        agent_args=()

        if [[ "$first_arg" == "happy" ]]; then
            run_mode="local-remote"
            agent="$2"

            if [[ -z "$agent" ]]; then
                echo -e "${RED}Error: Please specify agent${NC}"
                echo -e "${YELLOW}Usage: gbox happy <agent> [-- <args>]${NC}"
                echo -e "${YELLOW}Example: gbox happy claude${NC}"
                exit 1
            fi

            if ! is_valid_agent "$agent"; then
                echo -e "${RED}Error: Unsupported agent '$agent'${NC}"
                echo -e "${YELLOW}Supported agents: ${SUPPORTED_AGENTS[*]}${NC}"
                echo ""
                print_usage
                exit 1
            fi

            shift 2

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --memory|-m)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --memory/-m requires argument${NC}"
                            exit 1
                        fi
                        MEMORY_LIMIT="$1"
                        shift
                        ;;
                    --cpu|-c)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --cpu/-c requires argument${NC}"
                            exit 1
                        fi
                        CPU_LIMIT="$1"
                        shift
                        ;;
                    --ports)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --ports requires argument${NC}"
                            echo -e "${YELLOW}Format: --ports \"8000:8000;7000;7001\"${NC}"
                            exit 1
                        fi
                        CONTAINER_PORTS="$1"
                        shift
                        ;;
                    --ref-dirs)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --ref-dirs requires argument${NC}"
                            echo -e "${YELLOW}Format: --ref-dirs \"/path/to/dir1;/path/to/dir2\"${NC}"
                            exit 1
                        fi
                        CONTAINER_REF_DIRS="$1"
                        shift
                        ;;
                    --proxy)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --proxy requires argument${NC}"
                            echo -e "${YELLOW}Example: --proxy http://127.0.0.1:7890${NC}"
                            exit 1
                        fi
                        AGENT_PROXY="$1"
                        shift
                        ;;
                    --debug)
                        DEBUG="happy:*"
                        shift
                        ;;
                    --keep)
                        CONTAINER_KEEP="true"
                        shift
                        ;;
                    --name)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --name requires argument${NC}"
                            exit 1
                        fi
                        CONTAINER_NAME="$1"
                        shift
                        ;;
                    --)
                        shift
                        agent_args=("$@")
                        break
                        ;;
                    *)
                        echo -e "${RED}Error: Unknown gbox parameter '$1'${NC}"
                        echo -e "${YELLOW}Usage: gbox happy $agent [gbox-options] [-- <agent-args>]${NC}"
                        echo -e "${YELLOW}gbox options: --memory/-m, --cpu/-c, --ports, --ref-dirs, --proxy, --debug, --keep, --name${NC}"
                        echo -e "${YELLOW}Example: gbox happy $agent --memory 8g --cpu 4 --ports \"8000;7000\" -- --model=sonnet${NC}"
                        exit 1
                        ;;
                esac
            done
        else
            run_mode="only-local"
            agent="$first_arg"

            if ! is_valid_agent "$agent"; then
                echo -e "${RED}Error: Unsupported agent '$agent'${NC}"
                echo -e "${YELLOW}Supported agents: ${SUPPORTED_AGENTS[*]}${NC}"
                echo ""
                print_usage
                exit 1
            fi

            shift

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --memory|-m)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --memory/-m requires argument${NC}"
                            exit 1
                        fi
                        MEMORY_LIMIT="$1"
                        shift
                        ;;
                    --cpu|-c)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --cpu/-c requires argument${NC}"
                            exit 1
                        fi
                        CPU_LIMIT="$1"
                        shift
                        ;;
                    --ports)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --ports requires argument${NC}"
                            echo -e "${YELLOW}Format: --ports \"8000:8000;7000;7001\"${NC}"
                            exit 1
                        fi
                        CONTAINER_PORTS="$1"
                        shift
                        ;;
                    --ref-dirs)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --ref-dirs requires argument${NC}"
                            echo -e "${YELLOW}Format: --ref-dirs \"/path/to/dir1;/path/to/dir2\"${NC}"
                            exit 1
                        fi
                        CONTAINER_REF_DIRS="$1"
                        shift
                        ;;
                    --proxy)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --proxy requires argument${NC}"
                            echo -e "${YELLOW}Example: --proxy http://127.0.0.1:7890${NC}"
                            exit 1
                        fi
                        AGENT_PROXY="$1"
                        shift
                        ;;
                    --debug)
                        DEBUG="happy:*"
                        shift
                        ;;
                    --keep)
                        CONTAINER_KEEP="true"
                        shift
                        ;;
                    --name)
                        shift
                        if [[ $# -eq 0 ]]; then
                            echo -e "${RED}Error: --name requires argument${NC}"
                            exit 1
                        fi
                        CONTAINER_NAME="$1"
                        shift
                        ;;
                    --)
                        shift
                        agent_args=("$@")
                        break
                        ;;
                    *)
                        echo -e "${RED}Error: Unknown gbox parameter '$1'${NC}"
                        echo -e "${YELLOW}Usage: gbox $agent [gbox-options] [-- <agent-args>]${NC}"
                        echo -e "${YELLOW}gbox options: --memory/-m, --cpu/-c, --ports, --ref-dirs, --proxy, --debug, --keep, --name${NC}"
                        echo -e "${YELLOW}Example: gbox $agent --memory 8g --cpu 4 --ports \"8000;7000\" -- --model=sonnet${NC}"
                        exit 1
                        ;;
                esac
            done
        fi

        agent_session "$run_mode" "$agent" "${agent_args[@]}"
        ;;
esac
